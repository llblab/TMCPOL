# Спецификация `L2 TOL`

Данная спецификация определяет системы `L2 TOL`, которые выпускают собственные L2 токены (L2TOLT - L2 TOL Token), устанавливая при этом ликвидность второго уровня (L2 TOL) в паре с L1 токеном Native. L2 TOL могут использовать различные механизмы эмиссии, включая TMC (однонаправленную кривую бондинга) или кастомные стратегии минтинга. Ключевые инновации включают убывающую силу голоса, прогрессивные награды за участие и микро-стриминг по блокам для устранения MEV.

---

## Оглавление

1. [Основные определения](#1-основные-определения)
2. [Системные инварианты](#2-системные-инварианты)
3. [Механика управления](#3-механика-управления)
4. [Интеграция с казначейством](#4-интеграция-с-казначейством)
5. [Жизненный цикл L2 TOL](#5-жизненный-цикл-l2-toldao)
6. [Паттерн BLDR](#6-паттерн-bldr)
7. [Модель безопасности](#7-модель-безопасности)
8. [Параметры конфигурации](#8-параметры-конфигурации)
9. [Требования к реализации](#9-требования-к-реализации)

---

## 1. Основные определения

### Первичные сущности

- `Native (L1)` — Базовый токен парачейна, управляемый референдумами первого порядка на уровне L1
- `L2 TOL` — DAO второго уровня, поддерживающая L2 ликвидность, принадлежащую протоколу, в паре с L1 Native
- `Ecosystem L2 TOL` — L2 TOL, инициализированная экосистемным origin, получающая финансирование от L1 Treasury
- `L2TOLT` — L2 TOL DAO Token, выпускаемый L2 TOL с обязательной поддержкой TOL
- `L1 TOL` — Ликвидность, принадлежащая протоколу на уровне L1 (Native)
- `L2 TOL` — Ликвидность, принадлежащая протоколу второго уровня в L2 TOL
- `BLDR` — Канонический L2TOLT токен строителей для выплат экосистеме и разработки

### Механизмы

- `TMC` — Кривая Чеканки Токенов, один из возможных механизмов эмиссии для L2TOLT
- `L2 TMCTOL DAO` — Частный случай L2 TOL, объединяющий кривую чеканки токенов и принадлежащую протоколу ликвидность
- `Custom Emission` — Альтернативные механизмы минтинга, настраиваемые под требования L2 TOL
- `DripVault` — Контракт потокового вещания по блокам для непрерывных операций казначейства
- `Declining Power` — Убывающая сила голоса от 10x до 1x в течение периода голосования
- `Progressive Rewards` — Перераспределение, создающее соотношение 1:5 между пассивными и активными участниками
- `Team Shares` — Заблокированные доли с правами управления, но без возможности передачи
- `Invoice Voting` — Паттерн BLDR с механикой DOUBLE/APPROVE/REDUCE/VETO для выплат контрибьюторам

---

## 2. Системные инварианты

Каждая сертифицированная L2 TOL ДОЛЖНА обеспечивать соблюдение следующих инвариантов на блокчейне:

### 2.1 Управление L2 TOL

LP токены, помеченные как L2 TOL, могут управляться в двух режимах:

`Режим блокировки:`

- LP токены требуют для вывода:
  - Одобрение квалифицированным большинством L2 TOL (≥66%)
  - Обязательная временная блокировка (14 дней)
  - Окно вето для L1 Native (7 дней)

`Режим казначейства:`

- LP токены хранятся на балансе L2 DAO Treasury
- Управляются механизмами голосования DAO
- Гибкость настраивается при инициализации TOLDAO

### 2.2 Минимальная ликвидность Native

Начальный L2 TOL должен удовлетворять минимальным требованиям, конфигурируемым через параметры паллета L1 TOLDAO (устанавливаются через референдум L1):

```
L2_TOL_native ≥ configured_minimum_native
```

Это гарантирует корректность математики XYK и предотвращает dust-атаки.

### 2.3 Защита L2 TOL через L1 TOL

Когда L1 TOL держит токены L2TOLT любого L2 TOL:

- Холдинги L2TOLT в L1 TOL получают `постоянный множитель голосования 10x` на весь период голосования (без убывания)
- Прямые держатели L2TOLT испытывают убывающую силу (10x → 1x), L1 TOL сохраняет постоянные 10x
- Количество L2TOLT в L1 TOL определяется в момент подсчёта голосов
- Обеспечивает защиту на уровне экосистемы как для инициированных экосистемой, так и для созданных пользователями TOLDAO
- Держатели Native голосуют во втором треке для направления L1 TOL голосов

### 2.4 Требования к долям команды

Если существует распределение для команды:

- Минимальный вестинг 5 лет от последнего минтинга
- Полные права голосования в управлении во время вестинга
- Отсутствие передач до завершения вестинга
- Учитывается в расчётах защиты ограничением

### 2.5 Прозрачность телеметрии

Эмиссия в реальном времени на блокчейне:

- Глубина L2 TOL (резервы Native и L2TOLT)
- Балансы казначейства (включая заблокированные доли команды)
- Множители силы голоса и состояние убывания
- Уровни участия и распределение наград

### 2.6 Эволюционный дизайн

- Параметры системы и механизмы настраиваются через управление
- Протокол может эволюционировать при обнаружении лучших механик
- Изменения требуют консенсуса через установленные пути управления
- Эволюция по дизайну: непрерывное улучшение — основной принцип

### 2.7 Управление LP TOL казначейством

LP токены TOL от минтинга TMCTOL хранятся в казначействе для контролируемого управлением стратегического развёртывания. Этот паттерн применим как к Native TOLDAO (L1), так и к L2 TOL с различными областями управления:

```rust
struct TreasuryLpManager {
    tol_lp_balance: Balance,
    total_lp_accumulated: Balance,
}

impl TreasuryLpManager {
    fn store_tol_lp(lp_tokens: Balance) {
        Treasury::receive_lp_tokens(lp_tokens);
        Self::increment_accumulated(lp_tokens);
    }
}
```

`Стратегические возможности (L1 и L2):`

1. `Межпарачейновое развёртывание`: Через референдум управления LP можно перераспределить в пулы соседних парачейнов для стимулирования арбитража и усиления согласованности межцепочечного ценообразования
2. `Использование комиссий XYK`: Комиссии XYK по умолчанию составляют 0.0% для максимального сжатия диапазона. Управление может активировать комиссии (например, 0.3%), чтобы хранимые казначейством LP собирали торговые комиссии для программ обратного выкупа и сжигания (Native для L1, L2TOLT для L2)
3. `Ребалансировка ликвидности`: Казначейство может перемещать LP между пулами в ответ на меняющиеся рыночные условия при сохранении гарантии пола
4. `Мультитокенная ликвидность`: Для L2 TOL можно развёртывать LP через множественные торговые пары (L2TOLT/Native, L2TOLT/Foreign и т.д.)

`Различия области управления:`

| Аспект                   | Native TOLDAO (L1)                             | L2 TOL                                         |
| ------------------------ | ---------------------------------------------- | ---------------------------------------------- |
| `Голосующий орган`       | Держатели Native токена                        | Держатели L2TOLT + прокси казначейства L1      |
| `Диапазон развёртывания` | Все парачейны в экосистеме                     | Обычно в пределах экосистемы хост-парачейна    |
| `Использование комиссий` | Обратный выкуп и сжигание Native (опционально) | Обратный выкуп и сжигание L2TOLT (опционально) |
| `Права вето`             | Н/Д (управление верхнего уровня)               | L1 super user может наложить вето              |
| `Период голосования`     | Стандартно 14 дней                             | 7 дней (14 если вовлечён L1)                   |

`Процесс управления:`

- Развёртывание LP требует референдума управления (период голосования варьируется по уровню)
- Нет админ-ключей или одностороннего контроля на любом уровне
- Общий LP TOL отслеживается ончейн для прозрачности во всех развёртываниях
- Гарантия пола поддерживается независимо от местоположения LP или уровня управления
- Межуровневая координация: стратегические решения L2 TOL могут инициировать проверку L1, если значимы

`Критические инварианты (универсальные):`

- Собственность казначейства = постоянная протокольная собственность (нет индивидуального вывода на любом уровне)
- Все решения о стратегическом развёртывании требуют одобрения управления (L1 или L2 в зависимости от ситуации)
- Расчёт пола остаётся валидным при всех конфигурациях развёртывания и уровнях управления
- LP токены никогда не покидают контроль протокола, меняется только местоположение в контролируемых протоколом аккаунтах
- Требование прозрачности: все движения LP отслеживаются ончейн независимо от инициирующего уровня управления

---

## 3. Механика управления

### 3.1 Убывающая сила голоса

Вес голоса линейно убывает от 10x до 1x за разные периоды, стимулируя ранее участие:

```rust
fn calculate_voting_power(
    voter: AccountId,
    vote_time: Timestamp,
    vote_start: Timestamp,
    vote_end: Timestamp,
    base_weight: Balance,
    l1_tol_l2tolt_balance: Balance
) -> Balance {
    // Холдинги L1 TOL сохраняют постоянные 10x на протяжении всего периода голосования
    if voter == L1_TOL_ACCOUNT {
        return l1_tol_l2tolt_balance * 10;
    }

    // Обычные держатели испытывают убывающую силу
    let progress = (vote_time - vote_start) / (vote_end - vote_start);
    let multiplier = 10.0 - (9.0 * progress);

    // Применяем множитель GovXP для компетентных участников
    let govxp_multiplier = calculate_govxp_multiplier(voter);

    base_weight * multiplier * govxp_multiplier
}
```

`Свойства:`

- `Прямые держатели L2TOLT`: Убывающая сила от 10x (начало голосования) → 1x (конец голосования)
- `Холдинги L1 TOL`: Постоянный множитель 10x на весь период голосования (без убывания)
- `Множитель GovXP`: Дополнительный множитель от 1.0x до 3.0x на основе репутации участника
- Голосования L2 TOL: период 7 дней по умолчанию
- Голосования L1 Native TOLDAO: период 14 дней при участии
- Линейное убывание для прямых держателей предотвращает манипуляции в последнюю минуту
- Преимущество L1 TOL стимулирует участие экосистемы без экстремальных множителей
- GovXP усиливает влияние компетентных участников, создавая меритократическую систему

### 3.2 Прогрессивные награды за участие

#### 3.2.1 Система GovXP (Governance Experience Points)

GovXP — это непередаваемый (soulbound) числовой атрибут, привязанный к адресу кошелька, который динамически изменяется на основе доказуемых on-chain действий.

`Основные принципы:`

- **Награда за Компетентность, а не за Капитал**: GovXP смещает фокус с чистого владения токенами на качество принятия решений
- **Динамическая Репутация**: GovXP — это не статичное достижение, а постоянно обновляемый показатель
- **Двойное Влияние**: GovXP одновременно усиливает политическое влияние (силу голоса) и экономическую доходность
- **Прозрачность и Верифицируемость**: Все изменения GovXP основаны на публично проверяемых транзакциях

`Формула множителя GovXP (Кривая Мудрости):`

```rust
fn calculate_govxp_multiplier(govxp: u64) -> FixedU128 {
    let max_bonus = FixedU128::from(4.0);  // Максимальный бонус 4.0 (итоговый множитель 5.0x)
    let k = FixedU128::from(0.0005);       // Коэффициент крутизны кривой

    // Логистическая кривая (S-curve) для эффекта убывающей отдачи
    let exponent = -k * FixedU128::from(govxp);
    let sigmoid = FixedU128::from(2) / (FixedU128::from(1) + exponent.exp());

    FixedU128::from(1) + (max_bonus * (sigmoid - FixedU128::from(1)))
}
```

`Свойства кривой:`

- При GovXP = 0, множитель ≈ 1.0x
- Рост наиболее интенсивен в середине диапазона GovXP
- Множитель асимптотически приближается к 5.0x, предотвращая бесконечный рост влияния
- Эффект убывающей отдачи стимулирует постоянное участие, а не накопление

Активные участники управления получают увеличенные награды:

```rust
fn distribute_rewards(epoch: EpochId) -> Result<(), Error> {
    let base_reward = calculate_base_staking_reward();
    let active_voters = count_active_participants(epoch);
    let passive_stakers = total_stakers - active_voters;

    // Неучастники получают 20% от базовой награды
    let passive_reward = base_reward * 0.2;
    let total_passive_payout = passive_reward * passive_stakers;

    // Пул перераспределения из штрафов
    let penalty_pool = (base_reward * passive_stakers) - total_passive_payout;

    // Активные голосующие делят базовую награду + перераспределение с учетом GovXP
    let total_weighted_stake = calculate_total_weighted_stake(active_voters);
    for voter in active_voters {
        let govxp_multiplier = calculate_govxp_multiplier(voter);
        let weighted_stake = get_staked_balance(voter) * govxp_multiplier;
        let voter_reward = base_reward + (penalty_pool * weighted_stake / total_weighted_stake);
        distribute_to_voter(voter, voter_reward);
    }

    // Результат: до 3x награды за компетентное участие
    distribute(passive_stakers, passive_reward);
}
```

### 3.3 Преимущество голосования L1 TOL

#### 3.3.1 Механизмы начисления и списания GovXP

GovXP автоматически начисляется и списывается при разрешении системных событий:

| Действие      | Путь Прогрессии | Условие                                                 | Начисление/Списание GovXP    | Примечание                            |
| ------------- | --------------- | ------------------------------------------------------- | ---------------------------- | ------------------------------------- |
| Предсказание  | Оракул          | Успешный прогноз исхода голосования                     | +100                         | Стимулирует анализ                    |
| Предсказание  | Оракул          | Неверный прогноз исхода голосования                     | -50                          | Наказывает за спам                    |
| Голосование   | Стратег         | Голос на победившей стороне                             | + (10 × N_days_remaining)    | Вознаграждает ранние и верные решения |
| Предложение   | Стратег         | Авторство предложения, которое принято и выполнило KPI  | +500                         | Поощряет полезные инициативы          |
| Инвойс        | BLDR Строитель  | Инвойс получил итоговый множитель ≥ 1.0 (APPROVE)       | +250                         | Награда за хорошую работу             |
| Инвойс        | BLDR Строитель  | Инвойс получил итоговый множитель ≥ 1.5 (DOUBLE)        | +1000                        | Награда за выдающуюся работу          |
| Инвойс        | BLDR Строитель  | Инвойс был ветирован (>50% VETO)                        | -500                         | Наказание за некачественную работу    |
| Делегирование | Гражданин       | Делегат заработал GovXP (любым способом)                | + (Delegate_XP_Gained × 0.2) | Поощряет поиск и поддержку талантов   |
| Бездействие   | Общее           | Участник не совершил действий в течение эпохи (90 дней) | GovXP = GovXP × 0.99         | Медленное затухание для неактивных    |

`Формула итоговой силы голоса:`

```
Final_Vote_Weight = Token_Balance × Temporal_Multiplier × GovXP_Multiplier
```

- `Token_Balance`: Количество застейканных токенов (L2TOLT)
- `Temporal_Multiplier`: Временной множитель (10x → 1x в Declining Power)
- `GovXP_Multiplier`: Множитель от 1.0x до 5.0x на основе GovXP

`Формула распределения комиссий:`

```
Share_of_Fees = Total_Fees_Pool × (Staked_Balance × GovXP_Multiplier) / Global_Weighted_Stake
```

- `Total_Fees_Pool`: Общая сумма комиссий за эпоху
- `Staked_Balance`: Количество застейканных токенов участника
- `Global_Weighted_Stake`: Сумма произведений (Staked_Balance × GovXP_Multiplier) по всем участникам

`Холдинги L1 TOL (все L2 TOL):`

- Когда L1 TOL держит токены L2TOLT, они получают `постоянный множитель 10x` (без убывания)
- Прямые держатели L2TOLT испытывают убывающую силу (10x → 1x), L1 TOL сохраняет постоянные 10x
- GovXP множитель применяется ко всем участникам, включая L1 TOL (если применимо)
- Применяется универсально независимо от того, инициирован ли L2 TOL экосистемой или создан пользователями
- Количество L2TOLT в L1 TOL определяется в момент разрешения голосования
- Держатели Native голосуют во втором треке, решая как L1 TOL применит свои L2TOLT голоса
- Создает экономический стимул для L2 TOL иметь участие казначейства L1

`Сравнение силы голоса`:

```
Момент:        Начало  25%     50%     75%     Конец
Прямой:         10x    7.75x   5.5x    3.25x   1x
L1 TOL:         10x    10x     10x     10x     10x  ← Без убывания
GovXP Мин:      1x     1x      1x      1x      1x   ← Базовый множитель
GovXP Макс:     5x     5x      5x      5x      5x   ← Максимальный бонус (настраивается через голосование L1)
```

`Стратегические последствия`:

- Голоса L1 TOL имеют постоянный вес на весь период голосования
- Ранние прямые голосующие (10x) соответствуют силе L1 TOL изначально
- Поздние прямые голосующие (1x-3x) имеют значительно меньше влияния чем L1 TOL
- GovXP усиливает влияние компетентных участников независимо от времени голосования
- Стимулирует L2 TOL искать участие казначейства L1
- Сбалансированное преимущество без экстремальных множителей
- Создает меритократическую систему, где влияние зависит от доказанной компетентности
- Все параметры GovXP настраиваются через управление L1 для адаптивности системы

### 3.4 Механизмы разрешения управления

`Право вето супер-пользователя:`

- Супер-пользователь может наложить вето на любой референдум L2 TOL (как созданный пользователями, так и инициированный экосистемой)
- Вето немедленно отменяет референдум без дальнейшего голосования
- Обеспечивает окончательный механизм безопасности для критических проблем

`Двухтрековая система голосования:`
Когда L1 TOL держит токены L2TOLT, L2 TOL использует двухтрековый механизм голосования:

`Трек 1: Прямое голосование L2TOLT`

- Держатели L2TOLT голосуют напрямую с убывающей силой (10x → 1x)
- Применяются стандартные правила управления L2 TOL
- Производит победившую позицию (ЗА или ПРОТИВ) с общей силой голосов

`Трек 2: Прокси-голосование Native`

- Держатели Native (L1) голосуют о том, как L1 TOL должна применить свои холдинги L2TOLT
- Решение определяет, голосует ли L1 TOL своими L2TOLT за или против предложения
- `L2TOLT L1 TOL получают постоянный множитель 10x на весь период голосования`
- Количество L2TOLT в L1 TOL рассчитывается в момент разрешения голосования

Оба трека работают одновременно в течение 7 дней, затем система определяет результат:

`Путь 1: Консенсус (треки согласованы) - всего 7 дней`

- Оба трека голосуют одинаково (оба ЗА или оба ПРОТИВ)
- L2TOLT L1 TOL сохраняют постоянный множитель 10x (без убывания)
- Голоса суммируются: голоса Трека 1 (с убыванием) + (L2TOLT L1 TOL × 10)
- Немедленное исполнение после 7 дней

`Путь 2: Расхождение с преимуществом L1 TOL - всего 7 дней`

Когда треки голосуют противоположно И L1 TOL голоса (постоянные 10x) сильнее:

- Пример: Взвешенные голоса Трека 1 = 8000 ПРОТИВ, L1 TOL = 1000 L2TOLT × 10 = 10000 ЗА
- Постоянный множитель L1 TOL (10000 ЗА) превышает убывающие голоса Трека 1 (8000 ПРОТИВ)
- Результат: Позиция L1 TOL побеждает, голоса меньшинства Трека 1 игнорируются
- Финал: 10000 ЗА побеждает, немедленное исполнение

`Путь 3: Расхождение с задержкой исполнения - всего 14 дней`

Когда треки голосуют противоположно, НО Трек 1 остается сильнее чем L1 TOL:

- Пример: Взвешенные голоса Трека 1 = 8000 ПРОТИВ, L1 TOL = 500 L2TOLT × 10 = 5000 ЗА
- Победитель Трека 1 (8000 ПРОТИВ) превышает голоса L1 TOL (5000 ЗА)
- Результат: Позиция Трека 1 побеждает, но с 7-дневной задержкой исполнения
- Задержка дает время для L1 DAO инициировать референдум вето при необходимости

Критические действия, требующие участия L1 TOLDAO:

- Вывод или модификация L2 TOL
- Изменения параметров кривой бондинга
- Расходы казначейства выше порога
- Модификации правил управления

---

## 4. Интеграция с казначейством

### 4.1 Микро-стриминг по блокам

Устраняет MEV через непрерывные микротранзакции:

```rust
struct DripVault {
    total_allocation: Balance,
    blocks_remaining: BlockNumber,
    amount_per_block: Balance,
}

impl DripVault {
    fn initialize(allocation: Balance, duration_blocks: BlockNumber) -> Self {
        Self {
            total_allocation: allocation,
            blocks_remaining: duration_blocks,
            amount_per_block: allocation / duration_blocks,
        }
    }

    fn execute_block(&mut self) -> Balance {
        if self.blocks_remaining > 0 {
            self.blocks_remaining -= 1;
            self.amount_per_block  // Сумма слишком мала для прибыльного MEV
        } else {
            0
        }
    }
}
```

`Пример конфигурации:`

```
2-летний поток: 2 * 365 * 7200 блоков = 5,256,000 блоков
Сумма на блок: 10,000 NATIVE / 5,256,000 = 0.0019 NATIVE
Прибыль MEV: price_impact(0.0019) - gas_cost < 0 ✓
```

(amount_per_block, 0)
}

### 4.2 Режимы участия казначейства

1. `Разовое семя` — Немедленный обмен для стратегической позиции
2. `Поток DripVault` — Непрерывная поддержка в течение месяцев/лет
3. `Рециклирование доходов` — Процент дохода автоматически конвертируется в L2TOLT

---

## 5. Жизненный цикл L2 TOL

### 5.1 Фаза генезиса

`Требования для регистрации варьируются по фазам:`

- `Фаза 1: Экосистемные L2 TOL`

- Инициация через референдум L1 DAO
- Начальная аллокация Native определяется через голосование управления L1
- Конфигурация механизма эмиссии (параметры TMC, правила кастомного минтинга и т.д.)
- Распределение долей (user, l2_tol, treasury, team)
- График вестинга команды (минимум 5 лет)
- Управление: L1 TOL постоянные 10x (без убывания), прямые держатели убывающие 10x → 1x

`Фаза 2: Созданные пользователями L2 TOL`

- Регистрация без разрешений (не требуется голосование L1)
- Пользователь должен предоставить минимальный порог Native (устанавливается через параметры L1 DAO)
- Те же требования к эмиссии и распределению, что и для экосистемных TOLDAO
- Сумма долей равна ровно 100%
- Доля L2 TOL ≥ 20%
- График вестинга команды (минимум 5 лет)
- Управление: Прямые держатели убывающие 10x → 1x, если L1 TOL держит токены - постоянные 10x

`Проверки валидации (оба типа):`

- Сумма долей равна ровно 100%
- Доля L2 TOL ≥ 20%
- Начальный Native соответствует минимальным требованиям:
  - `Экосистемные`: Сумма, одобренная в референдуме L1
  - `Созданные пользователями`: Соответствует порогу, настроенному через параметры L1 DAO
- Механизм эмиссии правильно настроен
- График вестинга команды соответствует требованиям

### 5.2 Фаза запуска

`Последовательность активационного минтинга:`

1. Блокировка начального вклада Native
2. Выполнение первого минтинга через настроенный механизм эмиссии (TMC или кастомный)
3. Создание пула XYK с аллокацией L2 TOL
4. Настройка LP токенов согласно режиму управления TOL (заблокированные или на балансе казначейства)
5. Распределение казначейских и командных аллокаций
6. Активация механизмов управления

### 5.3 Операционная фаза

`Непрерывные операции:`

- Каждый минтинг проверяет ограничение и направляет в L2 TOL
- Предложения следуют пути двойного одобрения для критических действий
- Награды за участие рассчитываются и распределяются каждую эпоху
- DripVault выполняет потоковое вещание по блокам при настройке

### 5.4 Метрики зрелости

L2 TOL считается зрелой при:

- Глубина L2 TOL > 100,000 эквивалента NATIVE
- 6 месяцев положительного денежного потока
- Средний уровень участия > 30%
- Отсутствие вето критических предложений в течение 3 месяцев

---

## 6. Паттерн BLDR

### 6.1 Архитектура

BLDR служит канонической реализацией L2 TMCTOL DAO (использующей TMC) для прозрачной системы выплат:

```rust
struct BldrConfig {
    team_share: Permill,        // 0% для чистой модели казначейства
    treasury_share: Permill,    // 100% если нет команды
    invoice_cooldown: BlockNumber,
    max_invoice_size: Balance,
}
```

### 6.2 Поток счетов

Голосование по счётам объединяет убывающую силу с нюансированной механикой одобрения:

`Опции голосования`:

- `DOUBLE (×2.0)` — Выдающаяся работа, увеличить выплату (👍👍)
- `APPROVE (×1.0)` — Хорошая работа, согласен с запрошенной суммой (👍)
- `REDUCE (×0.5)` — Работа выполнена, но сумма завышена (👎)
- `VETO (блок)` — Заблокировать счёт полностью (❌)

`Логика разрешения`:

1. Проверить порог VETO в первую очередь:
   - Если `VETO > 50%` → Счёт отклонен немедленно (0 выплата)
   - Если `VETO ≤ 50%` → Голоса VETO игнорируются, переход к расчёту множителя

2. Рассчитать взвешенный множитель из голосов оценки (DOUBLE/APPROVE/REDUCE):

   ```
   Множитель = (DOUBLE_голоса × 2.0 + APPROVE_голоса × 1.0 + REDUCE_голоса × 0.5)
                / (DOUBLE_голоса + APPROVE_голоса + REDUCE_голоса)
   ```

3. Финальная выплата: `запрошенная_сумма × множитель`

`Процесс потока`:

1. `Подача` — Контрибьютор подаёт счёт с хешем результатов
2. `Период голосования` — 7 дней с убывающей силой (10x → 1x)
   - Холдинги BLDR в L1 TOL: постоянные 10x (без убывания)
   - Прямые держатели BLDR: убывание от 10x (рано) к 1x (поздно)
3. `Проверка VETO` — Если VETO > 50%, счёт отклонен
4. `Расчёт множителя` — Взвешенное среднее DOUBLE/APPROVE/REDUCE
5. `Выплата` — Автоматическая выплата: `база_сумма × множитель` в BLDR или Native
6. `Прогрессивные награды` — Активные голосующие получают ~2x vs пассивные держатели
7. `Отслеживание` — Ончейн-ссылка на выполненную работу

`Пример`:

```
Счёт: 1000 USDC запрошено

Распределение голосов:
- DOUBLE: 35% (350 токенов) → 700 взвешено
- APPROVE: 45% (450 токенов) → 450 взвешено
- REDUCE: 15% (150 токенов) → 75 взвешено
- VETO: 5% (50 токенов) → игнорируется (< 50%)

Множитель = (700 + 450 + 75) / (350 + 450 + 150) = 1.29
Финальная выплата: 1000 × 1.29 = 1,290 USDC
```

`Ключевые инсайты`:

- VETO двоичный (блокировка или разрешение), не часть ценообразования
- Голоса оценки (DOUBLE/APPROVE/REDUCE) определяют размер выплаты
- Ранние голосующие с 10x больше влияют на ценообразование чем поздние
- Холдинги BLDR в L1 TOL сохраняют постоянное 10x влияние на всё время
- Система естественно сходится к справедливому рыночному ценообразованию через повторение

### 6.3 Экономический цикл

```
Казначейство засевает BLDR → Контрибьюторы зарабатывают → Некоторые продают за Native →
Цена XYK падает → Выкуп казначейства → Повторная блокировка с множителем →
Более сильное управление → Лучшие решения → Больше ценности → Повторение
```

---

## 7. Модель безопасности

### 7.1 Векторы атак и меры противодействия

#### 7.1.1 Атаки на систему GovXP

`"Фарминг" через сговор:`

- **Вектор**: Группа участников создает тривиальные предложения и голосует за них для накрутки GovXP
- **Митигация**: Награда за авторство предложения привязана к выполнению реальных KPI, а не просто к факту принятия. "Храповик" и другие механизмы делают вредные предложения экономически невыгодными для всей системы

`Атака Сивиллы на делегирование:`

- **Вектор**: Злоумышленник создает множество аккаунтов, делегирует сам себе и пытается накрутить GovXP
- **Митигация**: GovXP зарабатывается на действиях, а не на факте делегирования. Чтобы получить GovXP от делегирования, основной аккаунт (делегат) должен сам совершать полезные действия. Атака становится экономически нецелесообразной

`"Окостенение" элиты:`

- **Вектор**: Ветераны с высоким GovXP могут подавлять новые идеи и создавать барьеры для новичков
- **Митигация**: Логистическая кривая GovXP_Multiplier создает "плато" (максимум 5.0x), не позволяя ветеранам стать всемогущими. Механизм затухания GovXP для неактивных участников гарантирует, что репутацию нужно постоянно поддерживать

`Манипуляция рынком предсказаний:`

- **Вектор**: Координация для создания ложных сигналов в оракуле предсказаний
- **Митигация**: Система штрафов за неверные предсказания (-50 GovXP) создает экономический барьер для спама. Успешные предсказания требуют реального анализа

| Вектор атаки             | Противодействие                               | Формула стоимости                              |
| ------------------------ | --------------------------------------------- | ---------------------------------------------- |
| `Захват через минтинг`   | L1 TOL постоянные 10x (без убывания)          | `стоимость > l1_tol_holdings × 10`             |
| `Мгновенное управление`  | Убывающая сила голоса (10x → 1x)              | `стоимость = full_position × 10 × lock_time`   |
| `Атака в конце периода`  | L1 TOL 10x когда остальные 1x                 | `стоимость > l1_tol_holdings × 10`             |
| `Захват L1 Native`       | Переопределение veto для критических действий | `стоимость > native_market_cap × quorum%`      |
| `Эксплуатация MEV`       | Потоковое вещание по блокам                   | `прибыль < 0` (невыгодно)                      |
| `Истощение казначейства` | Трёхпутевое разрешение + пороги               | Требует переопределение L1 или согласие L2 TOL |
| `Спам создания L2`       | Минимальный порог Native (Фаза 2)             | `стоимость = порог × native_price`             |
| `Мошенничество счётов`   | Порог VETO (>50% блокирует выплату)           | Бдительность сообщества + репутация            |

### 7.2 Экономическая безопасность

#### 7.2.1 Защита от манипуляций GovXP

`Вычислительная сложность:`

- Расчеты GovXP_Multiplier выполняются "на лету" при необходимости (голосование, распределение комиссий) и не хранятся в состоянии
- Массовые начисления (например, за голосование) спроектированы так, чтобы избежать исчерпания газа через ленивые выплаты или обработку по частям

`Параметрическая гибкость:`

- Все ключевые параметры GovXP (Max_Bonus, k, значения начисления/списания) изменяемы через L1-управление
- Система может адаптироваться и настраиваться с течением времени на основе реального опыта использования

`Экономическое выравнивание:`

- GovXP создает экономические стимулы для качественного участия, а не для простого накопления капитала
- Система естественно сходится к меритократической модели, где влияние пропорционально доказанной компетентности
- Медленное затухание GovXP для неактивных участников предотвращает "вечную элиту"

Минимальная стоимость атаки для любого L2 TOL:

```
Attack_cost = min(
    l1_tol_l2tolt × 10,          // L1 TOL постоянные 10x преимущество
    circulating_l2tolt × price × 5, // Нужно >50% с 1x против ранних 10x голосов
    native_market_cap × 0.1,      // Захват L1 Native
    opportunity_cost(10x_lockup)  // Капитал, взвешенный по времени
)
```

`Ключевые инсайты:`

- `Фаза 1`: Запускаются только экосистемные L2 TOL, проверенные через управление L1
- `Фаза 2`: Создание L2 TOL без разрешений с минимальным порогом Native предотвращает спам
- `Динамическое масштабирование защиты`: Созданные пользователями L2 TOL получают защиту экосистемного уровня, когда L1 TOL приобретает их токены L2TOLT
- `Преимущество L1 TOL`: Постоянные 10x (без убывания) обеспечивают надёжный уровень защиты экосистемы
- `Экономический барьер`: Порог обеспечивает только серьёзные проекты, настраивается через L1 DAO
- `Защита по времени`: Ранние голосующие (10x) и L1 TOL (постоянные 10x) доминируют в управлении

### 7.3 Уровни защиты

#### 7.3.1 Многоуровневая система безопасности GovXP

`Первый уровень — Экономические барьеры:`

- Штрафы за неверные предсказания и ветированные инвойсы
- Эффект убывающей отдачи в логистической криве множителя
- Медленное затухание репутации для неактивных участников

`Второй уровень — Временные ограничения:`

- Убывающая сила голоса предотвращает манипуляции в последнюю минуту
- Периоды блокировки для вывода LP токенов
- Вето супер-пользователя как окончательный механизм безопасности

`Третий уровень — Механизмы сообщества:`

- Делегирование GovXP поощряет поиск и поддержку талантов
- Система наград за успешные предложения стимулирует качественные инициативы
- Прозрачность всех изменений GovXP через публично проверяемые транзакции

`Четвертый уровень — Параметрическая адаптивность:`

- Все ключевые параметры GovXP управляемы через L1-референдумы
- Возможность корректировки системы на основе реального опыта
- Защита от "закостенения" системы через эволюционный дизайн

1. `Математический` — L1 TOL постоянные 10x (без убывания) обеспечивают надёжную защиту экосистемы
2. `Временной` — Убывающая сила (10x → 1x) для прямых держателей создаёт защиту по времени
3. `Экономический` — Стоимость атаки превышает потенциальную выгоду через множественные механизмы
4. `Разрешение` — Трёхпутевая система голосования обеспечивает соответствующие окна реагирования
5. `Социальный` — Прозрачные операции обеспечивают мониторинг
6. `Иерархический` — Вето супер-пользователя обеспечивает окончательный механизм безопасности

---

## 8. Параметры конфигурации

### 8.1 Рекомендуемые значения по умолчанию

#### 8.1.1 Параметры GovXP

```rust
const GOVXP_CONFIG: GovXpConfig = GovXpConfig {
    max_bonus: FixedU128::from(4.0),      // Максимальный бонус 4.0 (итоговый множитель 5.0x)
    k_coefficient: FixedU128::from(0.0005), // Коэффициент крутизны логистической кривой
    oracle_success_reward: 100,           // Награда за успешное предсказание
    oracle_failure_penalty: 50,           // Штраф за неверное предсказание
    winning_vote_base: 10,                // Базовая награда за верный голос
    proposal_success_reward: 500,         // Награда за успешное предложение
    invoice_approve_reward: 250,          // Награда за APPROVE инвойс
    invoice_double_reward: 1000,          // Награда за DOUBLE инвойс
    invoice_veto_penalty: 500,            // Штраф за VETO инвойс
    delegation_multiplier: FixedU128::from_rational(1, 5), // 20% от заработанного делегатом
    inactivity_decay: FixedU128::from_rational(99, 100),   // 1% затухания за эпоху бездействия
    inactivity_epochs: 91,                // Период бездействия для затухания (91 дней)
};
```

```rust
const DEFAULT_CONFIG: L2TolDaoConfig = L2TolDaoConfig {
    // Доли
    l2_tol_share: Permill::from_percent(33),
    treasury_share: Permill::from_percent(33),
    user_share: Permill::from_percent(34),
    team_share: Permill::from_percent(0),  // Или до 11%

    // Управление
    // Примечание: L1 TOL получает постоянный множитель 10x (без убывания) - не настраивается
    declining_power_start: 10,  // Прямые держатели начинают с 10x
    declining_power_end: 1,     // Прямые держатели заканчивают на 1x
    voting_period: 7 * DAYS,
    native_voting_period: 14 * DAYS,
    veto_override_threshold: 14 * DAYS,

    // Экономика
    min_native_floor: 1000 * UNITS,
    min_mint_amount: 100 * UNITS,
    buyback_threshold: Permill::from_percent(95),

    // Стриминг
    default_drip_duration: 2 * YEARS,
    blocks_per_drip: 1,
};
```

### 8.2 Схемы управления и фазированное развёртывание

`Фаза 1: Только экосистемные L2 TOL`

- Временная шкала запуска: Начальное развёртывание протокола
- Авторизация: Требуется референдум L1 DAO
- Начальный Native: Проголосованная сумма из казначейства L1
- Управление: L1 TOL постоянные 10x (без убывания), трёхпутевое разрешение
- Прямые держатели: Убывающая сила (10x → 1x)
- Примеры: BLDR (зарплаты), основные утилиты экосистемы
- Безопасность: Максимальная (проверено L1, финансируется L1)

`Фаза 2: Созданные пользователями L2 TOL`

- Временная шкала запуска: После стабильной работы Фазы 1
- Авторизация: Без разрешений (ограничено порогом)
- Начальный Native: Пользователь предоставляет минимальный порог (настраивается L1 DAO)
- Управление: Прямые держатели убывающая сила (10x → 1x), опциональное участие L1 TOL
- L1 TOL преимущество: Если L1 TOL держит L2TOLT, постоянные 10x (без убывания)
- Уровень защиты: Масштабируется с holdings L2TOLT в L1 TOL
- Безопасность: Экономический барьер (порог) + опциональное участие L1

`Типы схем управления:`

1. `Экосистемная схема` (стандарт Фазы 1)
   - L1 TOL постоянные 10x (без убывания) на holdings L2TOLT
   - Прямые держатели: убывающая сила (10x → 1x)
   - Трёхпутевое разрешение с автопаузой
   - Максимальная безопасность и поддержка L1

2. `Пользовательская схема` (стандарт Фазы 2)
   - Прямые держатели: убывающая сила голоса (10x → 1x)
   - L1 TOL может приобретать L2TOLT: постоянные 10x (без убывания)
   - Безопасность масштабируется с участием L1 TOL
   - Раннее участие (день 1-2) получает 10x как начальное преимущество

3. `Чистая схема L1-Proxy` (опциональная, любая фаза)
   - Все решения через референдум L1 TOLDAO
   - L2TOLT чисто экономический
   - Максимальная безопасность для критической инфраструктуры

---

## 9. Требования к реализации

### 9.1 Основные паллеты

```rust
trait L2TolDaoPallet {
    // Жизненный цикл
    fn register_dao(config: L2TolDaoConfig, origin: Origin) -> Result<DaoId, Error>;
    fn activate_dao(dao_id: DaoId, initial_native: Balance) -> Result<(), Error>;

    // Минтинг (реализация зависит от механизма эмиссии)
    fn mint(dao_id: DaoId, amount: Balance) -> Result<Balance, Error>;
    fn custom_emission(dao_id: DaoId, params: EmissionParams) -> Result<Balance, Error>;

    // Управление
    fn cast_vote(proposal: ProposalId, weight: Balance, conviction: u8);
    fn calculate_voting_power(
        voter: AccountId,
        time: Timestamp,
        vote_start: Timestamp,
        vote_end: Timestamp,
        base_weight: Balance,
        l1_tol_l2tolt_balance: Balance
    ) -> Balance;
    fn resolve_proposal(proposal: ProposalId) -> ResolutionPath;

    // Управление L2 TOL
    fn add_liquidity_to_l2_tol(dao_id: DaoId, native: Balance, l2pdt: Balance);
    fn get_l2_tol_reserves(dao_id: DaoId) -> (Balance, Balance);
}
```

### 9.2 Критические хуки

```rust
trait Hooks {
    fn on_mint(dao_id: DaoId, amount: Balance);
    fn on_vote_cast(voter: AccountId, power: Balance);
    fn on_proposal_executed(proposal: ProposalId);
    fn on_participation_reward(voter: AccountId, reward: Balance);
}
```

### 9.3 Хранилище

#### 9.3.1 GovXP Storage

```rust
/// Основное хранилище очков GovXP
#[pallet::storage]
pub(super) type GovXPStorage<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,
    u64,
    ValueQuery,
>;

/// Реестр делегирования GovXP
#[pallet::storage]
pub(super) type DelegateRegistry<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,  // Делегатор
    T::AccountId,  // Делегат
    OptionQuery,
>;

/// Данные голосований для расчета наград GovXP
#[pallet::storage]
pub(super) type ProposalVoters<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    DaoId,
    Blake2_128Concat,
    ProposalId,
    BoundedVec<(T::AccountId, VoteData), T::MaxVotersPerProposal>,
    ValueQuery,
>;

/// Конфигурация параметров GovXP
#[pallet::storage]
pub(super) type GovXpConfigStorage<T: Config> = StorageValue<
    _,
    GovXpConfig,
    ValueQuery,
>;
```

- Резервы L2 TOL и отслеживание LP токенов
- Графики убывания силы голоса
- История участия для наград
- Графики вестинга казначейства и команды
- Состояния потокового вещания DripVault

---

## Заключение

Архитектура L2 TOL позволяет DAO второго уровня работать с математическими гарантиями безопасности через:

1. `Убывающую силу голоса`, предотвращающую атаки на управление в последний момент
2. `Потоковое вещание по блокам`, полностью устраняющий MEV
3. `Прогрессивные награды`, стимулирующие активное участие
4. `Неизменность L2 TOL`, обеспечивающую постоянную ликвидность второго уровня
5. `Двухтрековое управление` с задержкой исполнения для потенциального вето L1
6. `Единый множитель 10x` для холдингов казначейства L1 в любом L2 TOL
7. `Evolution by Design`, обеспечивающий непрерывное улучшение протокола

Система создаёт устойчивые токеномические модели, где токены L2TOLT несут силу управления с обязательной поддержкой ликвидности второго уровня (L2 TOL), а участие казначейства обеспечивает выравнивание интересов без традиционных командных распределений, сохраняя при этом безопасность через экономические стимулы, а не бюрократические структуры.

---

- `Версия`: 1.0.0
- `Дата`: Ноябрь 2025
- `Автор`: LLB Lab
- `Лицензия`: MIT
